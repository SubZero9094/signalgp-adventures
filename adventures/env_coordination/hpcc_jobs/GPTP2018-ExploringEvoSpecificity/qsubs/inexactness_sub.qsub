#!/bin/bash -login

### Configure job:
#PBS -l walltime=04:00:00:00
#PBS -l feature=intel16
#PBS -l mem=8gb
#PBS -t 1-320
#PBS -N SGP_INEXACTNESS

### load necessary modules, e.g.
module load powertools

# === The importance of inexactness ===
# ENVIRONMENT_DISTRACTION_SIGNALS = 0

# -- EA -- (9 conditions: x30reps)
# RUN_MODE = 0
# SGP_HW_MIN_BIND_THRESH = 0.0, 0.125, 0.25, 0.375, 0.50, 0.625, 0.75, 0.875, 1.0
# GENERATIONS = 10000
# POP_INIT_METHOD = 0
# EVOLVE_SIMILARITY_THRESH = 0
# POP_SNAPSHOT_INTERVAL = 1000

# -- MAPE -- (1 condition: x50reps)
# RUN_MODE = 1
# SGP_HW_MIN_BIND_THRESH = 0.0
# GENERATIONS = 50000
# POP_INIT_METHOD = 1
# EVOLVE_SIMILARITY_THRESH = 1
# POP_SNAPSHOT_INTERVAL = 10000

# --- Array ranges for treatments ---
EVO_BT0000__MIN=1
EVO_BT0000__MAX=30
EVO_BT0125__MIN=31
EVO_BT0125__MAX=60
EVO_BT0250__MIN=61
EVO_BT0250__MAX=90
EVO_BT0375__MIN=91
EVO_BT0375__MAX=120
EVO_BT0500__MIN=121
EVO_BT0500__MAX=150
EVO_BT0625__MIN=151
EVO_BT0625__MAX=180
EVO_BT0750__MIN=181
EVO_BT0750__MAX=210
EVO_BT0875__MIN=211
EVO_BT0875__MAX=240
EVO_BT1000__MIN=241
EVO_BT1000__MAX=270

MAPE_MIN__MIN=271
MAPE_MIN__MAX=320

# --- General parameters ---
RUN_MODE=0
SGP_HW_MIN_BIND_THRESH=0.0
GENERATIONS=10000
POP_INIT_METHOD=0
EVOLVE_SIMILARITY_THRESH=0
POP_SNAPSHOT_INTERVAL=1000
ENVIRONMENT_DISTRACTION_SIGNALS=0

if [ ${PBS_ARRAYID} -ge ${EVO_BT0000__MIN} ] && [ ${PBS_ARRAYID} -le ${EVO_BT0000__MAX} ]; then
  SGP_HW_MIN_BIND_THRESH=0.0

elif [ ${PBS_ARRAYID} -ge ${EVO_BT0125__MIN} ] && [ ${PBS_ARRAYID} -le ${EVO_BT0125__MAX} ]; then
  SGP_HW_MIN_BIND_THRESH=0.125

elif [ ${PBS_ARRAYID} -ge ${EVO_BT0250__MIN} ] && [ ${PBS_ARRAYID} -le ${EVO_BT0250__MAX} ]; then
  SGP_HW_MIN_BIND_THRESH=0.25

elif [ ${PBS_ARRAYID} -ge ${EVO_BT0375__MIN} ] && [ ${PBS_ARRAYID} -le ${EVO_BT0375__MAX} ]; then
  SGP_HW_MIN_BIND_THRESH=0.375

elif [ ${PBS_ARRAYID} -ge ${EVO_BT0500__MIN} ] && [ ${PBS_ARRAYID} -le ${EVO_BT0500__MAX} ]; then
  SGP_HW_MIN_BIND_THRESH=0.50

elif [ ${PBS_ARRAYID} -ge ${EVO_BT0625__MIN} ] && [ ${PBS_ARRAYID} -le ${EVO_BT0625__MAX} ]; then
  SGP_HW_MIN_BIND_THRESH=0.625

elif [ ${PBS_ARRAYID} -ge ${EVO_BT0750__MIN} ] && [ ${PBS_ARRAYID} -le ${EVO_BT0750__MAX} ]; then
  SGP_HW_MIN_BIND_THRESH=0.75

elif [ ${PBS_ARRAYID} -ge ${EVO_BT0875__MIN} ] && [ ${PBS_ARRAYID} -le ${EVO_BT0875__MAX} ]; then
  SGP_HW_MIN_BIND_THRESH=0.875

elif [ ${PBS_ARRAYID} -ge ${EVO_BT1000__MIN} ] && [ ${PBS_ARRAYID} -le ${EVO_BT1000__MAX} ]; then
  SGP_HW_MIN_BIND_THRESH=1.0

elif [ ${PBS_ARRAYID} -ge ${MAPE_MIN__MIN} ] && [ ${PBS_ARRAYID} -le ${MAPE_MIN__MAX} ]; then
  RUN_MODE = 1
  GENERATIONS = 50000
  POP_INIT_METHOD = 1
  EVOLVE_SIMILARITY_THRESH = 1
  POP_SNAPSHOT_INTERVAL = 10000

fi

RANDOM_SEED=${PBS_ARRAYID}
DATA_DIR=/mnt/scratch/lalejini/data/gptp2018-evo-specificity/data
CONFIG_DIR=/mnt/scratch/lalejini/data/gptp2018-evo-specificity/configs

EXEC=l9_chg_env

RUN_NAME=RM${RUN_MODE}_BT${SGP_HW_MIN_BIND_THRESH}_DS${ENVIRONMENT_DISTRACTION_SIGNALS}_${RANDOM_SEED}

RUN_DIR=${DATA_DIR}/${RUN_NAME}

mkdir -p ${RUN_DIR}

# CD to appropriate directory
cd ${RUN_DIR}
# Copy over configs
cp -R ${CONFIG_DIR}/* ./

# Run experiment
./${EXEC} -RANDOM_SEED ${RANDOM_SEED} -RUN_MODE ${RUN_MODE} -SGP_HW_MIN_BIND_THRESH ${SGP_HW_MIN_BIND_THRESH} -GENERATIONS ${GENERATIONS} -POP_INIT_METHOD ${POP_INIT_METHOD} -EVOLVE_SIMILARITY_THRESH ${EVOLVE_SIMILARITY_THRESH} -POP_SNAPSHOT_INTERVAL ${POP_SNAPSHOT_INTERVAL} -ENVIRONMENT_DISTRACTION_SIGNALS ${ENVIRONMENT_DISTRACTION_SIGNALS} > run.log



